#!/bin/bash
# FIXED-COMPLETE-SETUP.sh
# Versi√≥n corregida que detecta autom√°ticamente el usuario PostgreSQL

set -e

echo "üöÄ SETUP COMPLETO CORREGIDO - DB + DEPLOYMENT"
echo "=============================================="

if [[ $(hostname) != *"dev-server"* ]] && [[ ! -f /srv/traefik/traefik.yml ]]; then
    echo "‚ùå Ejecutar en dev-server"
    exit 1
fi

echo "‚úÖ Ejecutando en dev-server"

# FASE 1: DETECTAR Y CONFIGURAR POSTGRESQL
echo ""
echo "üóÑÔ∏è FASE 1: DETECTANDO POSTGRESQL"
echo "==============================="

if docker ps | grep -q "dev-entersys-postgres"; then
    echo "‚úÖ Contenedor PostgreSQL encontrado: dev-entersys-postgres"
    
    # Detectar usuario PostgreSQL autom√°ticamente
    echo "üîç Detectando usuario PostgreSQL..."
    
    # Obtener variables de entorno del contenedor
    PG_USER=""
    if docker exec dev-entersys-postgres env | grep -q "POSTGRES_USER="; then
        PG_USER=$(docker exec dev-entersys-postgres env | grep "POSTGRES_USER=" | cut -d'=' -f2)
        echo "üìã Usuario encontrado en variables: $PG_USER"
    fi
    
    # Si no hay usuario espec√≠fico, probar usuarios comunes
    if [ -z "$PG_USER" ]; then
        echo "üß™ Probando usuarios comunes..."
        
        # Probar 'postgres'
        if docker exec dev-entersys-postgres psql -U postgres -c "SELECT 1;" >/dev/null 2>&1; then
            PG_USER="postgres"
            echo "‚úÖ Usuario 'postgres' funciona"
        # Probar sin especificar usuario
        elif docker exec dev-entersys-postgres psql -c "SELECT 1;" >/dev/null 2>&1; then
            PG_USER=""
            echo "‚úÖ Usuario por defecto funciona"
        # Probar 'entersys_user' si ya existe
        elif docker exec dev-entersys-postgres psql -U entersys_user -c "SELECT 1;" >/dev/null 2>&1; then
            PG_USER="entersys_user"
            echo "‚úÖ Usuario 'entersys_user' ya existe y funciona"
        else
            echo "‚ùå No se pudo determinar usuario PostgreSQL"
            echo "üîç Informaci√≥n del contenedor:"
            docker exec dev-entersys-postgres env | grep POSTGRES || echo "Sin variables POSTGRES"
            echo "üîß Intentando crear usuario postgres..."
            
            # √öltimo recurso: intentar como usuario root/default
            echo "üîß Intentando conexi√≥n como usuario por defecto del sistema..."
            
            # Probar diferentes enfoques para crear el usuario postgres
            docker exec dev-entersys-postgres sh -c "
                # Intentar como usuario postgres del sistema
                su - postgres -c 'createuser -s postgres' 2>/dev/null || 
                # O como root creando directamente en PostgreSQL
                psql -U \$(whoami) -c 'CREATE USER postgres WITH SUPERUSER;' 2>/dev/null ||
                echo 'Intentos de crear usuario fallaron'
            " || echo "No se pudo crear usuario postgres"
            
            # Probar de nuevo
            if docker exec dev-entersys-postgres psql -U postgres -c "SELECT 1;" >/dev/null 2>&1; then
                PG_USER="postgres"
                echo "‚úÖ Usuario postgres creado y funcionando"
            else
                echo "‚ùå Error cr√≠tico: No se puede conectar a PostgreSQL"
                exit 1
            fi
        fi
    fi
    
    echo "üéØ Usando usuario PostgreSQL: '$PG_USER'"
    
    # Configurar base de datos con el usuario detectado
    echo "üîß Configurando base de datos entersys_db..."
    
    if [ -n "$PG_USER" ]; then
        PSQL_CMD="psql -U $PG_USER -d postgres"
    else
        PSQL_CMD="psql -d postgres"
    fi
    
    docker exec dev-entersys-postgres $PSQL_CMD << 'EOSQL'
-- Crear base de datos si no existe
SELECT 'CREATE DATABASE entersys_db' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'entersys_db')\gexec

-- Crear usuario si no existe  
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'entersys_user') THEN
        CREATE USER entersys_user WITH ENCRYPTED PASSWORD 'entersys_dev_pass_2025';
        RAISE NOTICE 'User entersys_user created';
    ELSE
        RAISE NOTICE 'User entersys_user already exists';
    END IF;
END$$;

-- Grant privileges
GRANT ALL PRIVILEGES ON DATABASE entersys_db TO entersys_user;
ALTER USER entersys_user CREATEDB;

-- Conectar a la base espec√≠fica y dar permisos
\c entersys_db
GRANT ALL ON SCHEMA public TO entersys_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO entersys_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO entersys_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO entersys_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO entersys_user;
EOSQL
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ Base de datos configurada exitosamente"
        
        # Probar conexi√≥n con entersys_user
        echo "üß™ Probando conexi√≥n con entersys_user..."
        if docker exec dev-entersys-postgres psql -U entersys_user -d entersys_db -c "SELECT 'Test OK' as status;" >/dev/null 2>&1; then
            echo "‚úÖ Conexi√≥n de entersys_user exitosa"
        else
            echo "‚ö†Ô∏è entersys_user no puede conectar, pero base configurada"
        fi
    else
        echo "‚ùå Error configurando base de datos"
        exit 1
    fi
    
else
    echo "‚ùå Contenedor dev-entersys-postgres no encontrado"
    echo "Contenedores PostgreSQL disponibles:"
    docker ps | grep postgres || echo "Ninguno"
    exit 1
fi

# FASE 2: CREAR ESTRUCTURA DEL PROYECTO
echo ""
echo "üìÅ FASE 2: CREANDO ESTRUCTURA DEL PROYECTO"
echo "=========================================="

cd /srv/servicios
mkdir -p entersys-apis/content-management
cd entersys-apis/content-management

# Limpiar completamente el directorio
echo "üßπ Limpiando deployment anterior..."
rm -rf * .* 2>/dev/null || true

echo "üì• Clonando c√≥digo fuente..."
git clone https://github.com/EntersysMX/entersys-backend.git . --quiet

echo "‚öôÔ∏è Creando .env..."
cat > .env << 'ENVEOF'
POSTGRES_USER=entersys_user
POSTGRES_PASSWORD=entersys_dev_pass_2025
POSTGRES_SERVER=dev-entersys-postgres
POSTGRES_DB=entersys_db
POSTGRES_PORT=5432
ENVEOF

echo "‚úÖ Estructura del proyecto lista"

# FASE 3: CONFIGURAR REDES DOCKER
echo ""
echo "üîó FASE 3: CONFIGURANDO REDES DOCKER"
echo "===================================="

docker network create entersys_internal 2>/dev/null && echo "‚úÖ Red entersys_internal creada" || echo "‚úÖ Red entersys_internal ya existe"

if ! docker network ls | grep -q "traefik"; then
    echo "‚ùå Red traefik no existe - cre√°ndola"
    docker network create traefik
fi

echo "‚úÖ Redes configuradas"

# FASE 4: DEPLOYMENT SIMPLIFICADO
echo ""
echo "üöÄ FASE 4: DEPLOYMENT SIMPLIFICADO"
echo "=================================="

# Crear docker-compose.yml simple que funcione
echo "‚öôÔ∏è Creando configuraci√≥n de deployment..."

cat > docker-compose.yml << 'EOF'
version: '3.9'

services:
  content-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: entersys-content-api
    restart: unless-stopped
    
    env_file:
      - .env
      
    ports:
      - "8000:8000"  # Puerto expuesto para acceso directo
      
    networks:
      - traefik_network
      - entersys_internal
      
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.entersys-api.rule=Host(`api.dev.entersys.mx`)"
      - "traefik.http.routers.entersys-api.entrypoints=websecure"
      - "traefik.http.routers.entersys-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.entersys-api.loadbalancer.server.port=8000"

networks:
  traefik_network:
    name: traefik
    external: true
  entersys_internal:
    external: true
EOF

echo "‚úÖ Configuraci√≥n creada"

# Limpiar contenedores anteriores
echo "üßπ Limpiando contenedores anteriores..."
docker-compose down 2>/dev/null || true

# Desplegar
echo "üî® Desplegando aplicaci√≥n..."
docker-compose up -d --build --force-recreate

echo "‚è≥ Esperando 60 segundos para startup completo..."
sleep 60

# FASE 5: VERIFICACION
echo ""
echo "üß™ FASE 5: VERIFICACION"
echo "======================"

echo "üìä Estado del contenedor:"
docker-compose ps

echo ""
echo "üè• Test interno:"
if docker exec entersys-content-api curl -f -s http://localhost:8000/api/v1/health >/dev/null 2>&1; then
    echo "‚úÖ Health check interno exitoso"
    INTERNAL_RESPONSE=$(docker exec entersys-content-api curl -s http://localhost:8000/api/v1/health)
    echo "üìã Respuesta interna: $INTERNAL_RESPONSE"
else
    echo "‚ùå Health check interno fall√≥"
    echo "üìã Logs del contenedor:"
    docker logs --tail 15 entersys-content-api
    echo ""
    echo "üí° Revisar configuraci√≥n de base de datos o aplicaci√≥n"
    exit 1
fi

echo ""
echo "üåê Test externo HTTPS:"
sleep 20
if curl -f -s https://api.dev.entersys.mx/api/v1/health >/dev/null 2>&1; then
    echo "üéâ ¬°HTTPS FUNCIONA!"
    echo "‚úÖ URLs HTTPS disponibles:"
    echo "  ‚Ä¢ Health: https://api.dev.entersys.mx/api/v1/health"
    echo "  ‚Ä¢ Docs:   https://api.dev.entersys.mx/docs"
    echo "  ‚Ä¢ Root:   https://api.dev.entersys.mx/"
    echo ""
    echo "üìã Respuesta HTTPS:"
    curl -s https://api.dev.entersys.mx/api/v1/health
else
    echo "‚ö†Ô∏è HTTPS no funciona a√∫n, probando HTTP directo..."
    
    # Reiniciar Traefik y probar de nuevo
    docker restart traefik
    sleep 30
    
    if curl -f -s https://api.dev.entersys.mx/api/v1/health >/dev/null 2>&1; then
        echo "‚úÖ HTTPS funciona despu√©s de reiniciar Traefik"
        curl -s https://api.dev.entersys.mx/api/v1/health
    else
        echo "üß™ Probando acceso directo por puerto 8000..."
        if curl -f -s http://34.134.14.202:8000/api/v1/health >/dev/null 2>&1; then
            echo ""
            echo "üéØ ACCESO DIRECTO FUNCIONA"
            echo "========================="
            echo "‚úÖ URLs disponibles:"
            echo "  ‚Ä¢ Health: http://34.134.14.202:8000/api/v1/health"
            echo "  ‚Ä¢ Docs:   http://34.134.14.202:8000/docs"
            echo "  ‚Ä¢ Root:   http://34.134.14.202:8000/"
            echo ""
            echo "üìã Respuesta:"
            curl -s http://34.134.14.202:8000/api/v1/health
            echo ""
            echo "‚ö†Ô∏è Traefik/SSL tiene problemas, pero API funciona"
            echo "üí° Revisar configuraci√≥n DNS o certificados SSL"
        else
            echo "‚ùå Ning√∫n acceso externo funciona"
        fi
    fi
fi

echo ""
echo "‚úÖ SETUP COMPLETADO"
echo "==================="
echo "üê≥ Contenedor: entersys-content-api"
echo "üìÅ Ubicaci√≥n: /srv/servicios/entersys-apis/content-management"
echo "üóÑÔ∏è Database: entersys_db (en dev-entersys-postgres)"

echo ""
echo "üîß Comandos √∫tiles:"
echo "‚Ä¢ Ver logs: docker logs entersys-content-api"
echo "‚Ä¢ Reiniciar: docker-compose restart"
echo "‚Ä¢ Estado: docker-compose ps"
echo ""
echo "üéâ DEPLOYMENT FINALIZADO"