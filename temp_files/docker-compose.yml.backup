# docker-compose.yml (VERSIÃ“N FINAL Y ROBUSTA)
services:
  database:
    image: postgres:15-alpine
    container_name: dev-entersys-postgres
    restart: always
    volumes:
      - postgres_data:/var/lib/postgresql/data
    env_file: .env
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - entersys_net
  api:
    build: .
    container_name: entersys-content-api
    restart: always
    env_file: .env
    ports:
      - "8000:8000"
      - "8443:8000"
    networks:
      - entersys_net
      - traefik_net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.entersys-api-dev.rule=Host(`api.dev.entersys.mx`)"
      - "traefik.http.routers.entersys-api-dev.entrypoints=websecure"
      - "traefik.http.routers.entersys-api-dev.tls.certresolver=letsencrypt"
      - "traefik.http.services.entersys-api-dev.loadbalancer.server.port=8000"
    depends_on:
      database:
        condition: service_healthy
networks:
  traefik_net:
    name: traefik
    external: true
  entersys_net: {}
volumes:
  postgres_data:
    name: dev-entersys-pgdata
