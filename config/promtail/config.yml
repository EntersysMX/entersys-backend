# ğŸ“Š PROMTAIL CONFIGURATION FOR SIX SIGMA LOG MONITORING
# Homogeneous log collection from all Entersys services

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SCRAPE CONFIGURATIONS - ALL ENTERSYS SERVICES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

scrape_configs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # DOCKER CONTAINERS - ALL SERVICES
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - job_name: docker-containers
    static_configs:
      - targets:
          - localhost
        labels:
          job: docker-containers
          __path__: /var/lib/docker/containers/*/*.log

    pipeline_stages:
      # Parse Docker log format
      - json:
          expressions:
            output: log
            stream: stream
            timestamp: time

      # Extract container info from path
      - regex:
          expression: '.*containers/(?P<container_id>[^/]+)/.*'
          source: __path__

      # Add container labels
      - docker: {}

      # Parse application logs (try JSON first)
      - json:
          expressions:
            level: level
            message: message
            service: service
            request_id: request_id
            duration_ms: duration_ms
            status: status
            endpoint: endpoint
            method: method
            error_code: error.code
            user_id: user_id
          source: output
          drop_malformed: false

      # Extract log level from text if JSON parsing failed
      - regex:
          expression: '(?i)(?P<extracted_level>DEBUG|INFO|WARN|ERROR|FATAL)'
          source: output

      # Set log level
      - template:
          source: level
          template: '{{ or .level .extracted_level "INFO" }}'

      # Set service name from container name
      - template:
          source: service
          template: '{{ or .service .container_name "unknown" }}'

      # Add Six Sigma compliance labels
      - labels:
          level:
          service:
          container_name:
          request_id:
          method:
          status:
          stream:

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ENTERSYS API LOGS (SPECIFIC)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - job_name: entersys-api
    static_configs:
      - targets:
          - localhost
        labels:
          job: entersys-api
          service: entersys-api
          component: smartsheet-api
          __path__: /var/lib/docker/containers/*/entersys-content-api*.log

    pipeline_stages:
      # Parse Docker JSON
      - json:
          expressions:
            output: log
            timestamp: time

      # Parse structured API logs
      - json:
          expressions:
            level: level
            service: service
            request_id: request_id
            action: action
            duration_ms: duration_ms
            status: status
            endpoint: metadata.endpoint
            method: metadata.method
            status_code: metadata.status_code
            ip: metadata.ip
            user_agent: metadata.user_agent
            error_code: error.code
            error_message: error.message
          source: output

      # Calculate Six Sigma metrics
      - template:
          source: sla_breach
          template: |
            {{ if gt (float64 .duration_ms) 3000.0 }}true{{ else }}false{{ end }}

      - template:
          source: error_severity
          template: |
            {{ if ge (float64 .status_code) 500.0 }}critical{{ else if ge (float64 .status_code) 400.0 }}warning{{ else }}info{{ end }}

      # Add Six Sigma labels
      - labels:
          level:
          service: entersys-api
          request_id:
          action:
          status:
          method:
          sla_breach:
          error_severity:
          environment: production

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PROMETHEUS LOGS
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - job_name: prometheus
    static_configs:
      - targets:
          - localhost
        labels:
          job: prometheus
          service: prometheus
          component: metrics
          __path__: /var/lib/docker/containers/*/entersys-prometheus*.log

    pipeline_stages:
      - json:
          expressions:
            output: log
            timestamp: time

      - regex:
          expression: 'level=(?P<level>\w+).*msg="(?P<message>[^"]*)"'
          source: output

      - labels:
          level:
          service: prometheus

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # GRAFANA LOGS
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - job_name: grafana
    static_configs:
      - targets:
          - localhost
        labels:
          job: grafana
          service: grafana
          component: dashboard
          __path__: /var/lib/docker/containers/*/entersys-grafana*.log

    pipeline_stages:
      - json:
          expressions:
            output: log
            timestamp: time

      - regex:
          expression: 't=(?P<timestamp>[^\s]+)\s+lvl=(?P<level>\w+).*msg="(?P<message>[^"]*)"'
          source: output

      - labels:
          level:
          service: grafana

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # TRAEFIK LOGS (REVERSE PROXY)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - job_name: traefik
    static_configs:
      - targets:
          - localhost
        labels:
          job: traefik
          service: traefik
          component: reverse-proxy
          __path__: /var/lib/docker/containers/*/traefik*.log

    pipeline_stages:
      - json:
          expressions:
            output: log
            timestamp: time

      # Parse Traefik access logs
      - regex:
          expression: '(?P<client_ip>[^\s]+).*"(?P<method>\w+)\s+(?P<path>[^\s]+)\s+HTTP/[^"]*"\s+(?P<status_code>\d+)\s+(?P<bytes>\d+)'
          source: output

      # Add performance labels
      - template:
          source: performance_issue
          template: |
            {{ if ge (float64 .status_code) 500.0 }}server_error{{ else if ge (float64 .status_code) 400.0 }}client_error{{ else }}ok{{ end }}

      - labels:
          service: traefik
          method:
          status_code:
          performance_issue:

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # SYSTEM LOGS
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - job_name: syslog
    static_configs:
      - targets:
          - localhost
        labels:
          job: syslog
          service: system
          __path__: /var/log/syslog

    pipeline_stages:
      - regex:
          expression: '(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<hostname>\w+)\s+(?P<process>[^:]+):\s*(?P<message>.*)'

      - timestamp:
          source: timestamp
          format: 'Jan 2 15:04:05'

      - labels:
          hostname:
          process:
          service: system

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # DATABASE LOGS (PostgreSQL)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - job_name: postgresql
    static_configs:
      - targets:
          - localhost
        labels:
          job: postgresql
          service: database
          component: postgres
          __path__: /var/lib/docker/containers/*/dev-entersys-postgres*.log

    pipeline_stages:
      - json:
          expressions:
            output: log
            timestamp: time

      # Parse PostgreSQL logs
      - regex:
          expression: '(?P<timestamp>\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}\.\d+\s+UTC)\s+\[(?P<pid>\d+)\]\s+(?P<level>\w+):\s+(?P<message>.*)'
          source: output

      # Detect slow queries (Six Sigma performance)
      - regex:
          expression: 'duration:\s+(?P<duration_ms>\d+\.\d+)\s+ms'
          source: message

      - template:
          source: slow_query
          template: |
            {{ if gt (float64 .duration_ms) 1000.0 }}true{{ else }}false{{ end }}

      - labels:
          level:
          service: database
          slow_query:
          pid:

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # CUSTOM APPLICATION LOGS
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - job_name: custom-apps
    static_configs:
      - targets:
          - localhost
        labels:
          job: custom-apps
          __path__: /var/log/apps/*.log

    pipeline_stages:
      # Try to parse as JSON first
      - json:
          expressions:
            timestamp: timestamp
            level: level
            service: service
            message: message
            request_id: request_id
            duration_ms: duration_ms
            status: status
            method: method
            endpoint: endpoint
          drop_malformed: false

      # Fallback to text parsing
      - regex:
          expression: '(?P<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}[.]\d+Z)\s+(?P<level>\w+)\s+(?P<message>.*)'
          drop_malformed: false

      - labels:
          level:
          service:
          status: